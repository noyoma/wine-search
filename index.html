<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4tz5D3UVk8qjTburieJq-JmUsTw8k1SE_0poxXHNj9d2rIr2M58GpUC2J8oL77WP_Nl6-0aG1L6ZW/pub?gid=1560122813&single=true&output=csv";

const KEYS = [
  "ì™€ì¸ëª…(ì›ë¬¸)",
  "í•œê¸€ ë°œìŒ",
  "êµ­ê°€",
  "ì§€ì—­",
  "ì¢…ë¥˜",
  "ë¹ˆí‹°ì§€",
  "í’ˆì¢…",
  "êµ¬ë§¤ì²˜" // (trim ì²˜ë¦¬ ë•ë¶„ì— "êµ¬ë§¤ì²˜ "ë„ "êµ¬ë§¤ì²˜"ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤)
];

function safe(v) { return v ?? "-"; }

function formatPrice(price) {
  if (!price || price === "-") return "-";
  const num = Number(String(price).replace(/,/g, ""));
  if (Number.isNaN(num)) return String(price);
  return new Intl.NumberFormat('ko-KR').format(num) + "ì›";
}

// âœ… ì—¬ëŸ¬ í›„ë³´ ì»¬ëŸ¼ëª…ì—ì„œ êµ¬ë§¤ì²˜ë¥¼ ê°€ì ¸ì˜¤ë„ë¡(ì‹œíŠ¸ í—¤ë”ê°€ ë‹¬ë¼ë„ ëŒ€ì‘)
function getStore(w) {
  const candidates = ["êµ¬ë§¤ì²˜", "íŒë§¤ì²˜", "êµ¬ì…ì²˜", "shop", "store"];
  for (const k of candidates) {
    const v = w[k];
    if (v && String(v).trim() && v !== "-") return String(v).trim();
  }
  return "-";
}

// âœ… PapaParseê°€ ì½ì–´ì˜¨ rowì˜ key(í—¤ë”)ë¥¼ trimí•´ì„œ ì •ê·œí™”
function normalizeRowKeys(row) {
  const out = {};
  for (const k in row) {
    out[String(k).trim()] = row[k];
  }
  return out;
}

let allData = [];
let currentFilter = "all";

document.getElementById("status").innerHTML = '<div class="loading">ğŸ‡ ì™€ì¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

Papa.parse(CSV_URL, {
  download: true,
  header: true,
  complete: function(results) {
    // 1) í—¤ë” í™•ì¸ (ê°œë°œ ì¤‘ì—ë§Œ ì¼œë‘ì„¸ìš”)
    console.log("CSV headers:", results.meta.fields);
    // alert("CSV headers:\n" + results.meta.fields.join("\n"));

    // 2) row key ì •ê·œí™” + í•„í„°ë§
    allData = results.data
      .map(normalizeRowKeys)
      .filter(r => r["ì™€ì¸ëª…(ì›ë¬¸)"] && r["ì™€ì¸ëª…(ì›ë¬¸)"].trim());

    // ì¢…ë¥˜ë³„ í•„í„° ìƒì„±
    const types = [...new Set(allData.map(w => w["ì¢…ë¥˜"]).filter(Boolean))];
    const filtersHTML = `
      <button class="filter-btn active" data-type="all">ì „ì²´</button>
      ${types.map(t => `<button class="filter-btn" data-type="${t}">${t}</button>`).join('')}
    `;
    document.getElementById("filters").innerHTML = filtersHTML;

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.type;
        performSearch();
      });
    });

    const fuse = new Fuse(allData, {
      keys: KEYS,
      threshold: 0.35,
      ignoreLocation: true
    });

    window.fuseInstance = fuse;
    render(allData);

    document.getElementById("q").addEventListener("input", performSearch);
  }
});

function performSearch() {
  const term = document.getElementById("q").value.trim();
  let items = term ? window.fuseInstance.search(term).map(r => r.item) : allData;

  if (currentFilter !== "all") {
    items = items.filter(w => w["ì¢…ë¥˜"] === currentFilter);
  }

  render(items);
}

function render(items) {
  const status = document.getElementById("status");
  const list = document.getElementById("list");

  status.textContent = `${items.length}ê°œì˜ ì™€ì¸ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`;

  if (items.length === 0) {
    list.innerHTML = '<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ë³´ì„¸ìš”.</div>';
    return;
  }

  list.innerHTML = items.slice(0, 100).map(w => {
    const store = getStore(w);

    return `
      <div class="wine-card">
        <div class="wine-header">
          <div class="wine-name">${safe(w["ì™€ì¸ëª…(ì›ë¬¸)"])}</div>
          ${w["ë¹ˆí‹°ì§€"] && w["ë¹ˆí‹°ì§€"] !== "-" ? `<div class="vintage">${safe(w["ë¹ˆí‹°ì§€"])}</div>` : ''}
        </div>

        ${w["í•œê¸€ ë°œìŒ"] && w["í•œê¸€ ë°œìŒ"] !== "-" ? `<div class="wine-korean">${safe(w["í•œê¸€ ë°œìŒ"])}</div>` : ''}

        <div class="wine-details">
          ${w["ì¢…ë¥˜"] && w["ì¢…ë¥˜"] !== "-" ? `<span class="badge type">${safe(w["ì¢…ë¥˜"])}</span>` : ''}
          ${w["êµ­ê°€"] && w["êµ­ê°€"] !== "-" ? `<span class="badge country">${safe(w["êµ­ê°€"])}</span>` : ''}
          ${w["ì§€ì—­"] && w["ì§€ì—­"] !== "-" ? `<span class="badge">${safe(w["ì§€ì—­"])}</span>` : ''}
          ${w["í’ˆì¢…"] && w["í’ˆì¢…"] !== "-" ? `<span class="badge">${safe(w["í’ˆì¢…"])}</span>` : ''}
          ${store !== "-" ? `<span class="badge store">ğŸ›’ ${safe(store)}</span>` : ''}
        </div>

        <div class="wine-price">
          <div class="price">${formatPrice(w["ì›í™”í™˜ì‚°(ì›/ë³‘)"])}</div>
          ${w["ë³‘ìˆ˜"] && w["ë³‘ìˆ˜"] !== "-" ? `<div class="stock">ì¬ê³  ${safe(w["ë³‘ìˆ˜"])}ë³‘</div>` : ''}
        </div>
      </div>
    `;
  }).join("");
}
</script>
